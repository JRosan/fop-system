name: CD

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

env:
  DOTNET_VERSION: '9.0.x'
  NODE_VERSION: '20'
  AZURE_RESOURCE_GROUP_DEV: 'rg-fopsystem-dev'
  AZURE_RESOURCE_GROUP_STAGING: 'rg-fopsystem-staging'
  AZURE_RESOURCE_GROUP_PROD: 'rg-fopsystem-prod'

jobs:
  # Determine environment
  setup:
    name: Setup
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      resource_group: ${{ steps.set-env.outputs.resource_group }}
    steps:
      - name: Set environment
        id: set-env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "environment=dev" >> $GITHUB_OUTPUT
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
          fi

          # Set resource group based on environment
          ENV="${{ github.event.inputs.environment || 'dev' }}"
          if [ "$ENV" == "prod" ]; then
            echo "resource_group=${{ env.AZURE_RESOURCE_GROUP_PROD }}" >> $GITHUB_OUTPUT
          elif [ "$ENV" == "staging" ]; then
            echo "resource_group=${{ env.AZURE_RESOURCE_GROUP_STAGING }}" >> $GITHUB_OUTPUT
          else
            echo "resource_group=${{ env.AZURE_RESOURCE_GROUP_DEV }}" >> $GITHUB_OUTPUT
          fi

  # Deploy Infrastructure
  deploy-infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: setup
    environment: ${{ needs.setup.outputs.environment }}
    outputs:
      api_url: ${{ steps.deploy.outputs.apiAppUrl }}
      web_url: ${{ steps.deploy.outputs.webAppUrl }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure CLI Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Create Resource Group
        run: |
          az group create \
            --name ${{ needs.setup.outputs.resource_group }} \
            --location "East US"

      - name: Deploy Bicep
        id: deploy
        run: |
          DEPLOYMENT_OUTPUT=$(az deployment group create \
            --resource-group ${{ needs.setup.outputs.resource_group }} \
            --template-file infrastructure/bicep/main.bicep \
            --parameters environment=${{ needs.setup.outputs.environment }} \
            --parameters sqlAdminLogin=${{ secrets.SQL_ADMIN_LOGIN }} \
            --parameters sqlAdminPassword=${{ secrets.SQL_ADMIN_PASSWORD }} \
            --query properties.outputs -o json)

          echo "apiAppUrl=$(echo $DEPLOYMENT_OUTPUT | jq -r '.apiAppUrl.value')" >> $GITHUB_OUTPUT
          echo "webAppUrl=$(echo $DEPLOYMENT_OUTPUT | jq -r '.webAppUrl.value')" >> $GITHUB_OUTPUT

  # Run Database Migrations
  run-migrations:
    name: Run Database Migrations
    runs-on: ubuntu-latest
    needs: [setup, deploy-infrastructure]
    environment: ${{ needs.setup.outputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure CLI Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install EF Core tools
        run: dotnet tool install --global dotnet-ef

      - name: Get Key Vault secrets
        id: secrets
        run: |
          # Get Key Vault name from deployment
          KV_NAME=$(az keyvault list --resource-group ${{ needs.setup.outputs.resource_group }} --query "[0].name" -o tsv)

          # Get connection string
          CONNECTION_STRING=$(az keyvault secret show --vault-name $KV_NAME --name SqlConnectionString --query "value" -o tsv)
          echo "::add-mask::$CONNECTION_STRING"
          echo "connection_string=$CONNECTION_STRING" >> $GITHUB_OUTPUT

      - name: Run Migrations
        run: |
          dotnet ef database update \
            --project src/FopSystem.Infrastructure/FopSystem.Infrastructure.csproj \
            --startup-project src/FopSystem.Api/FopSystem.Api.csproj \
            --connection "${{ steps.secrets.outputs.connection_string }}"

  # Build and Deploy API
  deploy-api:
    name: Deploy API
    runs-on: ubuntu-latest
    needs: [setup, deploy-infrastructure, run-migrations]
    environment: ${{ needs.setup.outputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure CLI Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore FopSystem.sln

      - name: Build
        run: dotnet build FopSystem.sln --configuration Release --no-restore

      - name: Publish API
        run: |
          dotnet publish src/FopSystem.Api/FopSystem.Api.csproj \
            --configuration Release \
            --output ./publish/api

      - name: Get App Service name
        id: app-name
        run: |
          APP_NAME=$(az webapp list --resource-group ${{ needs.setup.outputs.resource_group }} --query "[?contains(name, 'app-api')].name" -o tsv)
          echo "name=$APP_NAME" >> $GITHUB_OUTPUT

      - name: Deploy to Azure App Service Staging Slot
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ steps.app-name.outputs.name }}
          slot-name: staging
          package: ./publish/api

      - name: Wait for staging slot to warm up
        run: sleep 30

      - name: Health check staging slot
        run: |
          STAGING_URL="https://${{ steps.app-name.outputs.name }}-staging.azurewebsites.net/health"
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" $STAGING_URL || echo "000")
          if [ "$HTTP_STATUS" != "200" ]; then
            echo "Health check failed with status: $HTTP_STATUS"
            exit 1
          fi
          echo "Staging health check passed"

      - name: Swap slots
        run: |
          az webapp deployment slot swap \
            --resource-group ${{ needs.setup.outputs.resource_group }} \
            --name ${{ steps.app-name.outputs.name }} \
            --slot staging \
            --target-slot production

  # Build and Deploy Web Frontend
  deploy-web:
    name: Deploy Web Frontend
    runs-on: ubuntu-latest
    needs: [setup, deploy-infrastructure, deploy-api]
    environment: ${{ needs.setup.outputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure CLI Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        working-directory: frontend
        run: pnpm install --frozen-lockfile

      - name: Build packages
        working-directory: frontend
        run: pnpm run build --filter=@fop/*

      - name: Build web app
        working-directory: frontend
        env:
          VITE_API_URL: ${{ needs.deploy-infrastructure.outputs.api_url }}
        run: pnpm run build --filter=web

      - name: Get Static Web App name
        id: swa-name
        run: |
          SWA_NAME=$(az staticwebapp list --resource-group ${{ needs.setup.outputs.resource_group }} --query "[0].name" -o tsv)
          echo "name=$SWA_NAME" >> $GITHUB_OUTPUT

      - name: Get Static Web App deployment token
        id: swa-token
        run: |
          TOKEN=$(az staticwebapp secrets list --name ${{ steps.swa-name.outputs.name }} --query "properties.apiKey" -o tsv)
          echo "::add-mask::$TOKEN"
          echo "token=$TOKEN" >> $GITHUB_OUTPUT

      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ steps.swa-token.outputs.token }}
          action: 'upload'
          app_location: 'frontend/apps/web'
          output_location: 'dist'
          skip_app_build: true

  # Notify on completion
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [setup, deploy-api, deploy-web]
    if: always()

    steps:
      - name: Notify success
        if: ${{ needs.deploy-api.result == 'success' && needs.deploy-web.result == 'success' }}
        run: |
          echo "Deployment to ${{ needs.setup.outputs.environment }} completed successfully!"
          echo "API URL: ${{ needs.deploy-infrastructure.outputs.api_url }}"
          echo "Web URL: ${{ needs.deploy-infrastructure.outputs.web_url }}"

      - name: Notify failure
        if: ${{ needs.deploy-api.result == 'failure' || needs.deploy-web.result == 'failure' }}
        run: |
          echo "Deployment to ${{ needs.setup.outputs.environment }} failed!"
          exit 1
